//editForm.tmpl

// The master template for the EditForm classes

var key string = strings.Title(dd.DbKey)
var formName = key + t.GoName + "EditForm"


{{
package form

// Code generated by goradd. DO NOT EDIT, since your changes will be lost the next time you generate code.
// To modify this form and preserver the changes, move this file to a different location,
// like the goradd-project/web/form directory, and also change the {{= key }}{{= t.GoName }}EditPath const below
// to a different path.

import (
    "github.com/goradd/goradd/pkg/page"
    .  "github.com/goradd/goradd/pkg/page/control"
    "goradd-project/gen/{{dd.DbKey}}/panel"
    "goradd-project/control"
    "context"
    "github.com/goradd/goradd/pkg/page/action"
    "fmt"
)

// {{= key }}{{= t.GoName }}EditPath specifies the URL that will access this form.
const {{= key }}{{= t.GoName }}EditPath = "/form/{{= dd.DbKey }}/{{= t.GoName }}Edit"
// {{= key }}{{= t.GoName }}EditID is the html id to use in the html form object.
const {{= key }}{{= t.GoName }}EditID = "{{= formName }}"
const {{= t.GoName }}Singular = "{{= t.LiteralName }}"
const {{= t.GoName }}Plural = "{{= t.LiteralPlural }}"

const (
    {{= t.GoName }}SaveAction = iota + 1
    {{= t.GoName }}CancelAction
    {{= t.GoName }}DeleteAction
)


// The {{= formName }} is a form wrapper for the corresponding edit panel.
// To edit it, make a copy and move it out of this package and into another
type {{= formName }} struct {
    control.FormBase
    EditPanel *panel.{{= t.GoName }}EditPanel
    SaveButton *Button
    CancelButton *Button
    DeleteButton *Button
}

func New{{= formName }}(ctx context.Context) page.FormI {
    f := new({{= formName }})
    f.Init(ctx, f, {{= key }}{{= t.GoName }}EditPath, {{= key }}{{= t.GoName }}EditID)
    return f
}

func (f *{{= formName }})Init(ctx context.Context, self page.FormI, path string, id string) {
    f.FormBase.Init(ctx, self, path, id)

	f.AddRelatedFiles()
	f.createControls(ctx)
}

// Run is called by the framework before the page is operated on, either through Ajax or Server calls.
// This is a good place to do anything that needs to happen before doing any of your actions or drawing,
// like checking if the user is authorized to access the page.
func (f *{{= formName }})Run(ctx context.Context) (err error) {

    // If you are authorizing the current user, do that here
    // if !authorized() {
    //    return page.FrameworkErrNotAuthorized
    //}

	return
}

// AddReleatedFiles is called by the framework to add javascript, css, and other files that the form
// will rely on.
func (f *{{= formName }}) AddReleatedFiles() {
    f.FormBase.AddRelatedFiles()

    // Add additional javascript, css and other files here
}

func (f *{{= formName }}) createControls(ctx context.Context) {
	f.EditPanel = panel.New{{= t.GoName }}EditPanel(f, "edit-panel")
	f.SaveButton = NewButton(f, "save-button")
    f.SaveButton.SetText(f.ΩT("Save"))
	f.SaveButton.OnSubmit(action.Ajax(f.ID(), {{= t.GoName }}SaveAction))
	f.CancelButton = NewButton(f, "cancel-button")
	f.CancelButton.SetText(f.ΩT("Cancel"))
	f.CancelButton.OnSubmit(action.Ajax(f.ID(), {{= t.GoName }}CancelAction))
	f.CancelButton.SetValidationType(page.ValidateNone)
	f.DeleteButton = NewButton(f, "delete-button")
	f.DeleteButton.SetText(f.ΩT("Delete"))

	// Two ways to customize the following message:
	//  1) Specify what singular version to use with a comment in the database.
	//  2) Remove all the actions on the button and replace with your own actions
	f.DeleteButton.OnSubmit(
	    action.Confirm(f.ΩT("Are you sure you want to delete this item?")),
	    action.Ajax(f.ID(), {{= t.GoName }}DeleteAction),
	    )
	f.DeleteButton.SetValidationType(page.ValidateNone)
}


// LoadControls is called by the framework after creating the form.
// It is the place to load up the form controls with data after the form has been created.
func (f *{{= formName }}) LoadControls(ctx context.Context) {
    if id, ok := page.GetContext(ctx).FormValue("id"); ok {
    	f.EditPanel.Load(ctx, id)
        f.DeleteButton.SetVisible(true)
        f.Page().SetTitle(f.ΩT("Edit"))
    } else {
        f.EditPanel.Load(ctx, "")
        f.DeleteButton.SetVisible(false)
        f.Page().SetTitle(f.ΩT("Create"))
    }
}

// Action is called by the framework to execute any Server or Ajax actions you have assigned to controls
// and directed here.
func (f *{{= formName }}) Action(ctx context.Context, a page.ActionParams) {
	switch a.ID {
	case {{= t.GoName }}SaveAction:
	    f.EditPanel.Save(ctx)
	    f.returnToPrevious()
    case {{= t.GoName }}CancelAction:
        f.returnToPrevious()
    case {{= t.GoName }}DeleteAction:
        f.EditPanel.Delete(ctx)
        f.returnToPrevious()
    }
}

func (f *{{= formName }}) returnToPrevious() {
{{# TODO: Use PopLocation instead? }}
	f.ChangeLocation("/form/{{= t.GoName }}List")
}

// init functions are called once when the web server first starts up.
func init() {
	page.RegisterPage({{= key }}{{= t.GoName }}EditPath,  New{{= formName }}, {{= key }}{{= t.GoName }}EditID)
}


}}

